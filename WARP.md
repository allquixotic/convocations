# Convocations Log Processor (Rust Implementation)

A high-performance Rust implementation of the convocations chat log processor that extracts and processes Elder Scrolls Online chat logs from weekly Saturday night role-playing sessions.

## LLMs: DO NOT MODIFY THIS FILE unless you are correcting a design inaccuracy. NEVER EVER EVER mention the current date or append updates on top of existing; ALWAYS delete obsolete information and REPLACE it with new information if you are updating this file.

When completing tasks, always create git commits for your changes, but NEVER push to remote repositories. The user will handle pushing manually.

### Build
- `cargo fmt`
- `cargo build --workspace`

### Next Up
- Wire up the frontend to consume the preset CRUD endpoints and persist only preset mutations when the user clicks the "Save" button.

## Overview

This tool replaces the original Python/Node.js implementation (`recent.py` + `index.js`) with a single Rust binary that performs all processing in one efficient process. It extracts dialogue from ESO's ChatLog.log file, formats it into readable narrative text, and optionally applies AI-powered grammar and spelling corrections.

## Key Features

- **Automated Date Filtering**: Extracts chat logs from specific time windows (Saturday nights, Tuesday evenings, Friday evenings)
- **Multiple Event Types**: Support for different recurring RP events with customizable durations
- **Smart Channel Filtering**: Only includes relevant channels (say and emote), filtering out guild/party/system messages
- **Multi-line Message Handling**: Properly reconstructs messages split across multiple lines with continuation markers (> and +)
- **AI-Powered Corrections**: Uses Google's Gemini AI for grammar and spelling improvements while preserving character names and fantasy terminology
- **Flexible Processing Modes**: Process raw ChatLog.log or pre-filtered files with toggleable processing stages
- **Secure API Key Management**: Encrypted storage of API keys using dotenvx
- **Cross-directory Support**: Output files are created in the directory where you run the command, not where the binary lives

## Build System

- **Rust workspace layout**
  - CLI: `crates/rconv-cli` (default binary target `rconv`)
  - Core library: `crates/rconv-core`
  - Tauri shell: `src-tauri`
  - Helper tooling: `tools/frontend-runner` (pure Rust, replaces Trunk’s beforeBuild/beforeDev scripts)
- **Frontend compilation**
  - Debug assets: `cargo run -p frontend-runner -- build-debug` (outputs to `frontend/dist`)
  - Release assets: `cargo run -p frontend-runner -- build-release`
  - Helper uses `wasm-bindgen-cli-support` to emit `app.js` + `app_bg.wasm` and injects a `<script type="module">` block into `dist/index.html`
  - Static files (`frontend/index.html`, `frontend/styles.css`) are copied verbatim into `dist/`
- **Tauri integration**
  - `src-tauri/tauri.conf.json` runs `frontend-runner` for both dev and release, so no Node tooling or `trunk serve` is required by default.
  - `cargo tauri dev` now serves the built assets directly from `frontend/dist` (no `devUrl` override required).
  - Release bundling confirmed via `cargo tauri build` (produces DMG/App bundle with fresh icons generated by `cargo tauri icon`).
- **Cargo aliases** (defined in `.cargo/config.toml`)
  - `cargo cli-run` / `cargo cli-run-release` – run the CLI in debug or release mode
  - `cargo cli-release` – build the CLI release binary
  - `cargo cli-deploy` – build + copy CLI to `~/.bin/convocations_bin`
  - `cargo frontend-build` / `cargo frontend-release` – produce debug or release frontend assets
  - `cargo gui-build` / `cargo gui-build-debug` – bundle the GUI (release or debug profiles)
  - `cargo gui-dev` – run `cargo tauri dev` after producing fresh debug assets
- **Manual Trunk workflow (optional)**
  - If live reload is required, run `trunk serve --address 127.0.0.1 --port 1420 frontend/index.html` yourself, then temporarily point `build.devUrl` to `http://localhost:1420/`.

## Installation Architecture

The tool uses a two-component architecture for security:

- `~/.bin/convocations` - Shell wrapper script that handles environment variable decryption
- `~/.bin/convocations_bin` - The actual Rust binary
- `~/Documents/convocations/rconv/.env` - Encrypted environment variables (via dotenvx)
- `~/Documents/convocations/rconv/.env.keys` - Encryption keys for dotenvx

## Usage Guide

### GUI Application

The Convocations Log Processor now includes a graphical user interface built with Tauri and Preact.

#### Starting the GUI

**Development Mode:**
```bash
cargo gui-dev
# alternative
cargo tauri dev
```

**Production Build:**
```bash
cargo gui-build
# alternative
cargo tauri build
```

The GUI provides a user-friendly interface for configuring and processing chat logs without needing to remember command-line flags.

#### GUI Features

- **Dual Mode Support**:
  - **Standard Mode**: Process ChatLog.log with automatic date filtering (Saturday events, RSM7, RSM8, TP6)
  - **Pre-filtered File Mode**: Process already-filtered files with configurable processing stages

- **Configuration Options**:
  - Event type selection (Saturday, RSM7, RSM8, TP6)
  - Weeks ago selector (0 = current week, 1 = last week, etc.)
  - Duration overrides (1 hour, 2 hours)
  - Custom date ranges (start/end dates)
  - Processing options (format dialogue, cleanup, LLM corrections)
  - Output file customization

- **Real-time Validation**:
  - Validates configuration before processing
  - Shows errors for invalid combinations (e.g., multiple event types)
  - Displays warnings for common issues (e.g., missing API key)

- **Progress Feedback**:
  - Visual feedback during processing
  - Success/error messages with output file paths
  - Clear error reporting

#### GUI Configuration

All settings from the CLI are available in the GUI through intuitive form controls:
- Checkboxes for boolean options
- Text inputs for file paths and dates
- Number inputs for weeks ago
- Mode switcher for standard vs pre-filtered processing

The GUI automatically validates your configuration and provides helpful feedback before processing begins.

## Processing Pipeline

1. **Date Calculation & Filtering**
   - Determines event type (Saturday/RSM7/RSM8/TP6) from flags
   - Calculates the most recent occurrence (or N occurrences ago)
   - Applies duration overrides if specified (--1h or --2h)
   - Converts Eastern Time to local timezone for non-Saturday events
   - Uses string comparison on ISO timestamps for efficiency

2. **Log Extraction & Parsing**
   - Reads ESO ChatLog.log (or pre-filtered file)
   - Extracts timestamp, channel, character name, and message
   - Filters to channels 0 (say) and 6 (emote) only

3. **Message Reconstruction**
   - Handles multi-line messages with > and + continuation markers
   - Maintains proper message ordering with msgid tracking
   - Preserves character dialogue attribution

4. **Text Cleanup (if enabled)**
   - Removes OOC content: ((text)) and [[text]]
   - Normalizes smart quotes to regular quotes
   - Converts ellipsis character to three periods
   - Ensures proper sentence-ending punctuation

5. **Dialogue Formatting (if enabled)**
   - Say channel: "Name says, \"message\""
   - Emote channel: "Name performs action" or "Name says, \"message\"" if quoted
   - Preserves quoted vs unquoted distinction

6. **AI Corrections (if enabled)**
   - Saves pre-LLM version to `{filename}_unedited.txt` (unless `--no-diff` is set)
   - Sends to Google Gemini AI in chunks
   - Preserves character names and fantasy terms
   - Maintains dialogue format exactly
   - Returns original text if API fails

7. **Output Generation**
   - Writes to specified file or default filename with prefix based on event type
   - Default filename format: `{prefix}-MMDDYY.txt` (e.g., `conv-101125.txt`, `rsm7-101425.txt`)
   - Creates file in current working directory
   - Warns if no data found for date range

8. **Diff Display (if LLM enabled and not --no-diff)**
   - Generates unified diff between pre-LLM and post-LLM versions
   - Displays diff with color coding to stdout
   - Deletes _unedited file unless `--keep-orig` is specified

## Environment Configuration

### API Key Setup

The tool requires a `GOOGLE_API_KEY` for AI corrections, stored encrypted via dotenvx:

```bash
cd ~/Documents/convocations/rconv
dotenvx set GOOGLE_API_KEY "your-api-key-here"
```

### Environment Variables

- `GOOGLE_API_KEY` - Required for AI corrections (encrypted via dotenvx)
- `CONVOCATIONS_WORKING_DIR` - Automatically set by wrapper script

## Building from Source

### Prerequisites

**For CLI:**
- Rust 1.89.0+ (via rustup)
- Cargo (comes with Rust)
- dotenvx (for environment encryption)

**Additional Prerequisites for GUI:**
- Trunk: `cargo install trunk --locked`
- wasm32-unknown-unknown target: `rustup target add wasm32-unknown-unknown`
- Tauri CLI: `cargo install tauri-cli --version '^2' --locked`

**Platform-Specific Dependencies:**
- **Linux**: `libwebkit2gtk-4.1-dev`, `build-essential`, `curl`, `wget`, `file`, `libssl-dev`, `libayatana-appindicator3-dev`, `librsvg2-dev`
- **macOS**: Xcode Command Line Tools
- **Windows**: Microsoft Visual Studio C++ Build Tools

### Build Steps

**CLI Only:**
```bash
cd ~/Documents/convocations/rconv
cargo build --release -p rconv
cp target/release/rconv ~/.bin/convocations_bin
```

**GUI Application:**
```bash
cd ~/Documents/convocations/rconv
cargo gui-build
# Bundles will be in src-tauri/target/release/bundle/
```

### Development Build

**CLI:**
```bash
cargo build
cargo run -- --dry-run
cargo run -- --last 1 test-output.txt
```

**GUI:**
```bash
cargo gui-dev
# Runs Tauri dev with freshly built debug assets
```

## CI/CD

GitHub Actions workflow (`.github/workflows/build.yml`) builds cross-platform binaries:

- **Linux x86-64**: `ubuntu-24.04`, target `x86_64-unknown-linux-gnu`
- **Windows x86-64**: `windows-latest`, target `x86_64-pc-windows-msvc`
- **MacOS Universal**: `macos-14`, targets `aarch64-apple-darwin` + `x86_64-apple-darwin` (combined with `lipo`)

**Triggers**: Push to main/master (builds only), push tag `v*` (builds + creates release), pull requests, manual dispatch.

**Creating a release**: `git tag v1.0.0 && git push origin v1.0.0` → GitHub Actions builds all platforms and creates release with archives.

**Artifacts**: `rconv-linux-x86_64.tar.gz`, `rconv-windows-x86_64.zip`, `rconv-macos-universal.tar.gz`

**Rust version**: 1.89.0 (can drop to 1.87 if needed; minimum 1.85 for 2024 edition support)

## Technical Details

### Architecture

The project is organized as a Cargo workspace with four main crates:

1. **rconv-core** (`crates/rconv-core/`): Shared processing logic, configuration structs, and main runtime
2. **rconv-cli** (`crates/rconv-cli/`): Command-line interface entry point
3. **rconv-tauri** (`src-tauri/`): Tauri backend with Rust commands for the GUI
4. **rconv-frontend** (`frontend/`): Preact-based frontend

### Dependencies

**Core Processing:**
- `clap` - Command-line argument parsing with derive macros
- `chrono` - Date/time handling and calculations
- `chrono-tz` - Timezone support for Eastern Time conversions
- `regex` - Pattern matching for log parsing
- `shellexpand` - Tilde expansion for file paths
- `google-ai-rs` - Google AI API client (Gemini)
- `tokio` - Async runtime for API calls
- `termdiff` - Unified diff generation with color output

**GUI Stack:**
- `tauri` - Desktop application framework (v2.8.5)
- `preact` - minimal react-ish framework
- `trunk` - WASM build tool and dev server
- `wasm-bindgen` - JavaScript/Rust interop
- `serde` / `serde-wasm-bindgen` - Serialization for Tauri commands

### Date Filtering Behavior

#### Event Types
- **Default** (no flags): Most recent Saturday 22:00 to Sunday 00:25
- **--rsm7**: Most recent Tuesday at 7pm Eastern (1 hour default)
- **--rsm8**: Most recent Tuesday at 8pm Eastern (1 hour default)
- **--tp6**: Most recent Friday at 6pm Eastern (1 hour default)
- **--last N**: Go back N occurrences of the selected event type (e.g., N Saturdays, N Tuesdays, N Fridays)

#### Duration Behavior
- Saturday events default to 2 hours 25 minutes (22:00 - 00:25)
- Other event types default to 1 hour
- **--1h**: Override to exactly 1 hour
- **--2h**: Override to exactly 2 hours

#### Timezone Handling
- Event type flags (--rsm7, --rsm8, --tp6) use **Eastern Time** for event start times
- Times are automatically converted to local timezone for ChatLog.log filtering
- Handles DST transitions correctly
- Date comparison uses substring matching on ISO format timestamps

### Error Handling

- File not found: Clear error message with path
- No data in date range: Warning with searched range
- API failures: Falls back to uncorrected text
- Empty output: Detailed warning with suggestions

### Security Architecture

The wrapper script design provides:
- API keys encrypted at rest on disk
- No hardcoded secrets in the binary
- Easy key rotation without recompilation
- Environment isolation via dotenvx

## Limitations (no plans to fix)

1. **Event Type Exclusivity**: Cannot use multiple event type flags simultaneously (--rsm7, --rsm8, --tp6)
2. **Duration Exclusivity**: Cannot use both --1h and --2h together
3. **Event Flags vs Custom Dates**: Cannot combine event/duration flags with custom --start/--end dates
4. **Channels**: Only processes channels 0 (say) and 6 (emote)
5. **API Token Limits**: Large sessions may need multiple API calls
6. **Output Location**: Default output goes to current directory, not source directory

## Troubleshooting

### Empty Output File
- Check date range matches actual chat activity
- Verify ChatLog.log contains data for the specified period
- Try `--dry-run` to see what dates are being searched
- Check file permissions on ChatLog.log

### API Errors
- Verify GOOGLE_API_KEY is set: `dotenvx get GOOGLE_API_KEY`
- Check API quota/limits in Google Cloud Console
- Use `--llm=false` to skip AI corrections
- Check network connectivity

### Date Filtering Issues
- Ensure dates are in ISO format: YYYY-MM-DDTHH:MM
- Event type flags use Eastern Time; times are auto-converted to local
- Saturday night sessions cross into Sunday morning
- Check that you're not mixing incompatible flags (event types, durations, custom dates)

